{#
/**
 * @file
 * Template for Site Analyzer Watchdog Analysis page.
 *
 * Available variables:
 * - watchdog_data: Array containing watchdog analysis data
 */
#}

<div class="site-analyzer-watchdog">
  <div class="unified-header">
    <div class="header-content">
      <h1 class="page-title">
        <span class="title-icon">üìã</span>
        {{ 'Watchdog Analysis'|t }}
      </h1>
      <p class="page-description">
        {{ 'Analysis of 404 errors, PHP errors, and system logs'|t }}
      </p>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary refresh-btn" onclick="refreshWatchdogAnalysis()">
        <span class="btn-icon">üîÑ</span>
        {{ 'Refresh Analysis'|t }}
      </button>
    </div>
  </div>
  
  {# Include Site Analyzer navigation after the title #}
  {% if site_analyzer_navigation %}
    {% include '@site_analyzer/site-analyzer-navigation.html.twig' with {
      'navigation_items': site_analyzer_navigation.navigation_items,
      'current_page': site_analyzer_navigation.current_page
    } %}
  {% endif %}

  {% if watchdog_data %}
    <div class="watchdog-analysis-content">
      
      {# Watchdog Status #}
      {% if watchdog_data.watchdog_status %}
        <div class="analysis-section watchdog-status">
          <h2>{{ 'Watchdog Status'|t }}</h2>
          <div class="status-grid">
            <div class="status-item">
              <strong>{{ 'Database Logging:'|t }}</strong> 
              <span class="status-{{ watchdog_data.watchdog_status.dblog_enabled ? 'enabled' : 'disabled' }}">
                {{ watchdog_data.watchdog_status.dblog_enabled ? 'Enabled'|t : 'Disabled'|t }}
              </span>
            </div>
            <div class="status-item">
              <strong>{{ 'Syslog:'|t }}</strong> 
              <span class="status-{{ watchdog_data.watchdog_status.syslog_enabled ? 'enabled' : 'disabled' }}">
                {{ watchdog_data.watchdog_status.syslog_enabled ? 'Enabled'|t : 'Disabled'|t }}
              </span>
            </div>
            <div class="status-item">
              <strong>{{ 'Logging Available:'|t }}</strong> 
              <span class="status-{{ watchdog_data.watchdog_status.logging_enabled ? 'enabled' : 'disabled' }}">
                {{ watchdog_data.watchdog_status.logging_enabled ? 'Yes'|t : 'No'|t }}
              </span>
            </div>
          </div>
        </div>
      {% endif %}

      {# 404 Error Analysis #}
      {% if watchdog_data.error_404_analysis %}
        <div class="analysis-section error-404-analysis">
          <h2>{{ '404 Error Analysis'|t }}</h2>
          
          {% if watchdog_data.error_404_analysis.enabled %}
            <div class="error-stats">
              <div class="stats-grid">
                <div class="stat-item">
                  <div class="stat-number">{{ watchdog_data.error_404_analysis.count_404 }}</div>
                  <div class="stat-label">{{ '404 Errors'|t }}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number">{{ watchdog_data.error_404_analysis.percent_404 }}%</div>
                  <div class="stat-label">{{ 'of Total Logs'|t }}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number">{{ watchdog_data.error_404_analysis.total_entries }}</div>
                  <div class="stat-label">{{ 'Total Log Entries'|t }}</div>
                </div>
              </div>
              
              <div class="status-indicator status-{{ watchdog_data.error_404_analysis.status }}">
                {{ watchdog_data.error_404_analysis.recommendation }}
              </div>
            </div>

            {% if watchdog_data.error_404_analysis.top_404_urls %}
              <div class="top-404-urls">
                <h3>{{ 'Top 404 URLs'|t }}</h3>
                <table class="table">
                  <thead>
                    <tr>
                      <th>{{ 'URL'|t }}</th>
                      <th>{{ 'Count'|t }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for url, count in watchdog_data.error_404_analysis.top_404_urls %}
                      <tr>
                        <td><code>{{ url }}</code></td>
                        <td>{{ count }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}

            {% if watchdog_data.error_404_analysis.recent_404s %}
              <div class="recent-404s">
                <h3>{{ 'Recent 404 Errors'|t }}</h3>
                <table class="table">
                  <thead>
                    <tr>
                      <th>{{ 'Time'|t }}</th>
                      <th>{{ 'Message'|t }}</th>
                      <th>{{ 'IP Address'|t }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for error in watchdog_data.error_404_analysis.recent_404s %}
                      <tr>
                        <td>{{ error.formatted_time }}</td>
                        <td>{{ error.message }}</td>
                        <td>{{ error.hostname }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}
          {% else %}
            <div class="alert alert-warning">
              {{ watchdog_data.error_404_analysis.message }}
            </div>
          {% endif %}
        </div>
      {% endif %}

      {# PHP Error Analysis #}
      {% if watchdog_data.php_error_analysis %}
        <div class="analysis-section php-error-analysis">
          <h2>{{ 'PHP Error Analysis'|t }}</h2>
          
          {% if watchdog_data.php_error_analysis.enabled %}
            <div class="error-stats">
              <div class="stats-grid">
                <div class="stat-item">
                  <div class="stat-number">{{ watchdog_data.php_error_analysis.count_php_errors }}</div>
                  <div class="stat-label">{{ 'PHP Errors'|t }}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number">{{ watchdog_data.php_error_analysis.percent_php }}%</div>
                  <div class="stat-label">{{ 'of Total Logs'|t }}</div>
                </div>
              </div>
              
              <div class="status-indicator status-{{ watchdog_data.php_error_analysis.status }}">
                {{ watchdog_data.php_error_analysis.recommendation }}
              </div>
            </div>

            {% if watchdog_data.php_error_analysis.error_types %}
              <div class="error-types">
                <h3>{{ 'Error Types Breakdown'|t }}</h3>
                <div class="error-types-grid">
                  {% for type, count in watchdog_data.php_error_analysis.error_types %}
                    <div class="error-type-item">
                      <div class="error-type-name">{{ type }}</div>
                      <div class="error-type-count">{{ count }}</div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}

            {% if watchdog_data.php_error_analysis.recent_errors %}
              <div class="recent-php-errors">
                <h3>{{ 'Recent PHP Errors'|t }}</h3>
                <table class="table">
                  <thead>
                    <tr>
                      <th>{{ 'Time'|t }}</th>
                      <th>{{ 'Severity'|t }}</th>
                      <th>{{ 'Message'|t }}</th>
                      <th>{{ 'Location'|t }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for error in watchdog_data.php_error_analysis.recent_errors %}
                      <tr class="severity-{{ error.severity }}">
                        <td>{{ error.formatted_time }}</td>
                        <td>{{ error.severity }}</td>
                        <td>{{ error.message|length > 100 ? error.message|slice(0, 100) ~ '...' : error.message }}</td>
                        <td>{{ error.location }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}
          {% else %}
            <div class="alert alert-warning">
              {{ watchdog_data.php_error_analysis.message }}
            </div>
          {% endif %}
        </div>
      {% endif %}

      {# Watchdog Statistics #}
      {% if watchdog_data.watchdog_statistics %}
        <div class="analysis-section watchdog-statistics">
          <h2>{{ 'Watchdog Statistics'|t }}</h2>
          
          {% if watchdog_data.watchdog_statistics.enabled %}
            <div class="stats-overview">
              <div class="stat-item large">
                <div class="stat-number">{{ watchdog_data.watchdog_statistics.total_entries }}</div>
                <div class="stat-label">{{ 'Total Log Entries'|t }}</div>
              </div>
            </div>

            {% if watchdog_data.watchdog_statistics.entries_by_type %}
              <div class="entries-by-type">
                <h3>{{ 'Entries by Type'|t }}</h3>
                <table class="table">
                  <thead>
                    <tr>
                      <th>{{ 'Type'|t }}</th>
                      <th>{{ 'Count'|t }}</th>
                      <th>{{ 'Percentage'|t }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for type, count in watchdog_data.watchdog_statistics.entries_by_type %}
                      <tr>
                        <td>{{ type }}</td>
                        <td>{{ count }}</td>
                        <td>{{ ((count / watchdog_data.watchdog_statistics.total_entries) * 100)|round(2) }}%</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}

            {% if watchdog_data.watchdog_statistics.entries_by_severity %}
              <div class="entries-by-severity">
                <h3>{{ 'Entries by Severity'|t }}</h3>
                <div class="severity-grid">
                  {% for severity, count in watchdog_data.watchdog_statistics.entries_by_severity %}
                    <div class="severity-item severity-{{ severity|lower }}">
                      <div class="severity-name">{{ severity }}</div>
                      <div class="severity-count">{{ count }}</div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          {% else %}
            <div class="alert alert-warning">
              {{ watchdog_data.watchdog_statistics.message }}
            </div>
          {% endif %}
        </div>
      {% endif %}

      {# Log Age Analysis #}
      {% if watchdog_data.log_age_analysis %}
        <div class="analysis-section log-age-analysis">
          <h2>{{ 'Log Age Analysis'|t }}</h2>
          
          {% if watchdog_data.log_age_analysis.enabled %}
            {% if watchdog_data.log_age_analysis.age_days is defined %}
              <div class="log-age-info">
                <p><strong>{{ 'Oldest Entry:'|t }}</strong> {{ watchdog_data.log_age_analysis.oldest_formatted }}</p>
                <p><strong>{{ 'Newest Entry:'|t }}</strong> {{ watchdog_data.log_age_analysis.newest_formatted }}</p>
                <p><strong>{{ 'Log Span:'|t }}</strong> {{ watchdog_data.log_age_analysis.age_days }} {{ 'days'|t }}</p>
                
                {% if watchdog_data.log_age_analysis.age_days > 90 %}
                  <div class="alert alert-info">
                    {{ 'Log entries span over 90 days. Consider implementing log rotation for better performance.'|t }}
                  </div>
                {% endif %}
              </div>
            {% else %}
              <div class="alert alert-info">
                {{ watchdog_data.log_age_analysis.message }}
              </div>
            {% endif %}
          {% else %}
            <div class="alert alert-warning">
              {{ watchdog_data.log_age_analysis.message }}
            </div>
          {% endif %}
        </div>
      {% endif %}

      {# Error Trends #}
      {% if watchdog_data.error_trends %}
        <div class="analysis-section error-trends">
          <h2>{{ 'Error Trends'|t }}</h2>
          
          {% if watchdog_data.error_trends.enabled %}
            <div class="trends-grid">
              {% for period, count in watchdog_data.error_trends.trends %}
                <div class="trend-item">
                  <div class="trend-period">{{ period|replace({'_': ' '})|title }}</div>
                  <div class="trend-count">{{ count }}</div>
                  <div class="trend-label">{{ 'Errors'|t }}</div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-warning">
              {{ watchdog_data.error_trends.message }}
            </div>
          {% endif %}
        </div>
      {% endif %}

      {# Recommendations #}
      {% if watchdog_data.recommendations %}
        <div class="analysis-section watchdog-recommendations">
          <h2>{{ 'Recommendations'|t }}</h2>
          <div class="recommendations-list">
            {% for recommendation in watchdog_data.recommendations %}
              <div class="recommendation recommendation-{{ recommendation.type }} priority-{{ recommendation.priority }}">
                <div class="recommendation-header">
                  <span class="recommendation-type">{{ recommendation.type|title }}</span>
                  <span class="recommendation-priority">{{ recommendation.priority|title }}</span>
                </div>
                <div class="recommendation-message">{{ recommendation.message }}</div>
                <div class="recommendation-category">{{ 'Category:'|t }} {{ recommendation.category }}</div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}

    </div>
  {% else %}
    <div class="alert alert-info">
      {{ 'Watchdog analysis data is not available. Please check the watchdog analyzer service.'|t }}
    </div>
  {% endif %}
</div>

<style>
.site-analyzer-watchdog {
  padding: 20px;
}

.unified-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid #e0e0e0;
}

.header-content {
  flex: 1;
}

.page-title {
  display: flex;
  align-items: center;
  margin: 0 0 10px 0;
  font-size: 2.2em;
  font-weight: 600;
  color: #333;
}

.title-icon {
  margin-right: 12px;
  font-size: 1.1em;
}

.page-description {
  margin: 0;
  font-size: 1.1em;
  color: #666;
  line-height: 1.4;
}

.header-actions {
  display: flex;
  gap: 10px;
  align-items: flex-start;
  margin-top: 10px;
}

.btn {
  display: inline-flex;
  align-items: center;
  padding: 8px 16px;
  border: 1px solid transparent;
  border-radius: 4px;
  font-size: 14px;
  font-weight: 500;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-primary {
  background-color: #0073aa;
  color: white;
  border-color: #0073aa;
}

.btn-primary:hover {
  background-color: #005a87;
  border-color: #005a87;
}

.btn-secondary {
  background-color: #f7f7f7;
  color: #333;
  border-color: #ccc;
}

.btn-secondary:hover {
  background-color: #e7e7e7;
  border-color: #bbb;
}

.btn-icon {
  margin-right: 6px;
  font-size: 0.9em;
}

.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-menu {
  display: none;
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  min-width: 180px;
  z-index: 1000;
}

.dropdown:hover .dropdown-menu {
  display: block;
}

.dropdown-item {
  display: block;
  padding: 8px 12px;
  color: #333;
  text-decoration: none;
  border-bottom: 1px solid #eee;
}

.dropdown-item:hover {
  background-color: #f5f5f5;
}

.dropdown-item:last-child {
  border-bottom: none;
}

.dropdown-arrow {
  margin-left: 6px;
  font-size: 0.8em;
}

.analysis-section {
  margin-bottom: 40px;
  padding: 20px;
  border: 1px solid #ddd;
  border-radius: 5px;
  background: #f9f9f9;
}

.analysis-section h2 {
  margin-top: 0;
  color: #333;
  border-bottom: 1px solid #ccc;
  padding-bottom: 10px;
}

.status-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.status-item {
  padding: 10px;
  background: white;
  border-radius: 5px;
  border: 1px solid #ddd;
}

.status-enabled {
  color: #5cb85c;
  font-weight: bold;
}

.status-disabled {
  color: #d9534f;
  font-weight: bold;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.stat-item {
  text-align: center;
  padding: 20px;
  background: white;
  border-radius: 5px;
  border: 1px solid #ddd;
}

.stat-item.large {
  grid-column: 1 / -1;
  max-width: 300px;
  margin: 0 auto;
}

.stat-number {
  font-size: 2em;
  font-weight: bold;
  color: #333;
}

.stat-label {
  margin-top: 5px;
  color: #666;
  font-size: 0.9em;
}

.status-indicator {
  padding: 15px;
  border-radius: 5px;
  margin-top: 15px;
  font-weight: bold;
}

.status-pass {
  background-color: #dff0d8;
  color: #3c763d;
  border: 1px solid #d6e9c6;
}

.status-warn {
  background-color: #fcf8e3;
  color: #8a6d3b;
  border: 1px solid #faebcc;
}

.status-fail {
  background-color: #f2dede;
  color: #a94442;
  border: 1px solid #ebccd1;
}

.status-info {
  background-color: #d9edf7;
  color: #31708f;
  border: 1px solid #bce8f1;
}

.table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  background: white;
}

.table th,
.table td {
  padding: 8px 12px;
  text-align: left;
  border-bottom: 1px solid #ddd;
}

.table th {
  background-color: #f5f5f5;
  font-weight: bold;
}

.error-types-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.error-type-item {
  text-align: center;
  padding: 15px;
  background: white;
  border-radius: 5px;
  border: 1px solid #ddd;
}

.error-type-name {
  font-weight: bold;
  margin-bottom: 5px;
}

.error-type-count {
  font-size: 1.5em;
  color: #d9534f;
  font-weight: bold;
}

.severity-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.severity-item {
  text-align: center;
  padding: 15px;
  background: white;
  border-radius: 5px;
  border: 1px solid #ddd;
}

.severity-name {
  font-weight: bold;
  margin-bottom: 5px;
}

.severity-count {
  font-size: 1.3em;
  font-weight: bold;
}

.severity-emergency .severity-count,
.severity-alert .severity-count,
.severity-critical .severity-count {
  color: #d9534f;
}

.severity-error .severity-count {
  color: #f0ad4e;
}

.severity-warning .severity-count {
  color: #f0ad4e;
}

.severity-notice .severity-count,
.severity-info .severity-count {
  color: #5bc0de;
}

.severity-debug .severity-count {
  color: #5cb85c;
}

.trends-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.trend-item {
  text-align: center;
  padding: 15px;
  background: white;
  border-radius: 5px;
  border: 1px solid #ddd;
}

.trend-period {
  font-weight: bold;
  margin-bottom: 5px;
}

.trend-count {
  font-size: 1.5em;
  color: #d9534f;
  font-weight: bold;
}

.trend-label {
  margin-top: 5px;
  color: #666;
  font-size: 0.9em;
}

.alert {
  padding: 15px;
  margin-bottom: 20px;
  border: 1px solid transparent;
  border-radius: 4px;
}

.alert-success {
  color: #3c763d;
  background-color: #dff0d8;
  border-color: #d6e9c6;
}

.alert-warning {
  color: #8a6d3b;
  background-color: #fcf8e3;
  border-color: #faebcc;
}

.alert-error {
  color: #a94442;
  background-color: #f2dede;
  border-color: #ebccd1;
}

.alert-info {
  color: #31708f;
  background-color: #d9edf7;
  border-color: #bce8f1;
}

.recommendations-list {
  margin-top: 15px;
}

.recommendation {
  padding: 15px;
  margin-bottom: 15px;
  border-left: 4px solid #ddd;
  background: white;
  border-radius: 0 5px 5px 0;
}

.recommendation-error {
  border-left-color: #d9534f;
}

.recommendation-warning {
  border-left-color: #f0ad4e;
}

.recommendation-info {
  border-left-color: #5bc0de;
}

.recommendation-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-weight: bold;
}

.recommendation-type {
  text-transform: uppercase;
  font-size: 0.85em;
}

.recommendation-priority {
  font-size: 0.85em;
  opacity: 0.7;
}

.recommendation-category {
  margin-top: 10px;
  font-size: 0.9em;
  opacity: 0.8;
}

code {
  background-color: #f5f5f5;
  padding: 2px 4px;
  border-radius: 3px;
  font-family: monospace;
}
</style>

<script>
function refreshWatchdogAnalysis() {
  // Show loading state
  const button = document.querySelector('.refresh-btn');
  const originalText = button.innerHTML;
  button.innerHTML = '<span class="btn-icon">‚è≥</span>' + Drupal.t('Refreshing...');
  button.disabled = true;
  
  // Reload the current page
  window.location.reload();
}
</script>