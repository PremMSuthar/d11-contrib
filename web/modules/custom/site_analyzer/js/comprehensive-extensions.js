/**\n * @file\n * JavaScript for comprehensive extensions analysis.\n */\n\n(function ($, Drupal, once) {\n  'use strict';\n\n  /**\n   * Comprehensive Extensions Analysis behavior.\n   */\n  Drupal.behaviors.comprehensiveExtensionsAnalysis = {\n    attach: function (context, settings) {\n      once('comprehensive-extensions', '.site-analyzer-comprehensive-extensions', context).forEach(function (element) {\n        // Initialize comprehensive analysis functionality\n        initializeComprehensiveAnalysis(element);\n      });\n    }\n  };\n\n  function initializeComprehensiveAnalysis(container) {\n    // Table sorting and filtering\n    initializeTableControls(container);\n    \n    // Analysis actions\n    initializeAnalysisActions(container);\n    \n    // Modal functionality\n    initializeModalControls(container);\n    \n    // Export functionality\n    initializeExportControls(container);\n  }\n  \n  function initializeTableControls(container) {\n    // Search functionality\n    const searchInput = container.querySelector('#extension-search');\n    if (searchInput) {\n      searchInput.addEventListener('input', function() {\n        filterTable(container);\n      });\n    }\n    \n    // Filter controls\n    const filters = container.querySelectorAll('.filter-select');\n    filters.forEach(function(filter) {\n      filter.addEventListener('change', function() {\n        filterTable(container);\n      });\n    });\n    \n    // Clear filters\n    const clearBtn = container.querySelector('.clear-filters-btn');\n    if (clearBtn) {\n      clearBtn.addEventListener('click', function() {\n        clearAllFilters(container);\n      });\n    }\n    \n    // Sortable columns\n    const sortableHeaders = container.querySelectorAll('.sortable');\n    sortableHeaders.forEach(function(header) {\n      header.addEventListener('click', function() {\n        sortTable(container, this.dataset.sort);\n      });\n    });\n  }\n  \n  function initializeAnalysisActions(container) {\n    // Individual analysis buttons\n    container.addEventListener('click', function(e) {\n      if (e.target.matches('.analyze-btn') || e.target.closest('.analyze-btn')) {\n        const btn = e.target.matches('.analyze-btn') ? e.target : e.target.closest('.analyze-btn');\n        runIndividualAnalysis(btn.dataset.name, btn.dataset.type);\n      }\n      \n      if (e.target.matches('.details-btn') || e.target.closest('.details-btn')) {\n        const btn = e.target.matches('.details-btn') ? e.target : e.target.closest('.details-btn');\n        showDetailedAnalysis(btn.dataset.name, btn.dataset.type);\n      }\n      \n      if (e.target.matches('.analyze-all-btn') || e.target.closest('.analyze-all-btn')) {\n        const btn = e.target.matches('.analyze-all-btn') ? e.target : e.target.closest('.analyze-all-btn');\n        runFullAnalysis(btn.dataset.action);\n      }\n    });\n  }\n  \n  function initializeModalControls(container) {\n    // Modal close buttons\n    container.addEventListener('click', function(e) {\n      if (e.target.matches('.modal-close')) {\n        const modal = e.target.closest('.modal');\n        if (modal) {\n          modal.style.display = 'none';\n        }\n      }\n    });\n    \n    // Close modal on outside click\n    container.addEventListener('click', function(e) {\n      if (e.target.matches('.modal')) {\n        e.target.style.display = 'none';\n      }\n    });\n  }\n  \n  function initializeExportControls(container) {\n    // Export buttons\n    container.addEventListener('click', function(e) {\n      if (e.target.matches('.export-btn') || e.target.closest('.export-btn')) {\n        const btn = e.target.matches('.export-btn') ? e.target : e.target.closest('.export-btn');\n        const format = btn.dataset.format;\n        const extensionName = btn.dataset.name;\n        \n        if (extensionName) {\n          exportExtensionReport(extensionName, format);\n        } else {\n          exportFullReport(format);\n        }\n      }\n    });\n  }\n  \n  function runIndividualAnalysis(name, type) {\n    showLoadingOverlay('Analyzing ' + name + '...');\n    \n    // Get AJAX URLs from settings\n    const settings = drupalSettings.siteAnalyzer || {};\n    const analyzeUrl = settings.ajaxUrls?.analyze || '/admin/reports/site-analyzer/analyze-extension';\n    \n    fetch(analyzeUrl, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'X-Requested-With': 'XMLHttpRequest'\n      },\n      body: JSON.stringify({\n        name: name,\n        type: type,\n        analysis_type: 'comprehensive'\n      })\n    })\n    .then(response => response.json())\n    .then(data => {\n      hideLoadingOverlay();\n      if (data.success) {\n        updateExtensionRow(name, data.results);\n        showSuccessMessage('Analysis completed for ' + name);\n      } else {\n        showErrorMessage('Analysis failed: ' + (data.error || 'Unknown error'));\n      }\n    })\n    .catch(error => {\n      hideLoadingOverlay();\n      showErrorMessage('Analysis failed: ' + error.message);\n    });\n  }\n  \n  function showDetailedAnalysis(name, type) {\n    const modal = document.getElementById('detailed-analysis-modal');\n    const content = document.getElementById('detailed-analysis-content');\n    \n    if (!modal || !content) {\n      console.error('Modal elements not found');\n      return;\n    }\n    \n    // Show modal\n    modal.style.display = 'block';\n    \n    // Load detailed analysis content\n    content.innerHTML = '<div class=\"loading-spinner\"></div><p>Loading detailed analysis...</p>';\n    \n    const settings = drupalSettings.siteAnalyzer || {};\n    const detailedUrl = (settings.ajaxUrls?.detailed || '/admin/reports/site-analyzer/detailed-analysis/') + name;\n    \n    fetch(detailedUrl)\n      .then(response => response.json())\n      .then(data => {\n        content.innerHTML = generateDetailedAnalysisHTML(data);\n        initializeDetailedAnalysisTabs(content);\n      })\n      .catch(error => {\n        content.innerHTML = '<div class=\"error-message\">Failed to load detailed analysis: ' + error.message + '</div>';\n      });\n  }\n  \n  function generateDetailedAnalysisHTML(data) {\n    return `\n      <div class=\"detailed-analysis\">\n        <div class=\"analysis-tabs\">\n          <div class=\"tab-nav\">\n            <button class=\"tab-button active\" data-tab=\"overview\">Overview</button>\n            <button class=\"tab-button\" data-tab=\"code-quality\">Code Quality</button>\n            <button class=\"tab-button\" data-tab=\"security\">Security</button>\n            <button class=\"tab-button\" data-tab=\"performance\">Performance</button>\n            <button class=\"tab-button\" data-tab=\"upgrade\">Upgrade</button>\n            <button class=\"tab-button\" data-tab=\"recommendations\">Recommendations</button>\n          </div>\n          \n          <div class=\"tab-content active\" id=\"overview\">\n            <h4>Extension Overview</h4>\n            <div class=\"overview-grid\">\n              <div class=\"metric-card\">\n                <h5>Overall Score</h5>\n                <div class=\"score-display\">${data.scores?.overall_score || 0}%</div>\n              </div>\n              <div class=\"metric-card\">\n                <h5>Risk Level</h5>\n                <div class=\"risk-display risk-${data.risk_assessment?.risk_level || 'unknown'}\">${data.risk_assessment?.risk_level || 'Unknown'}</div>\n              </div>\n              <div class=\"metric-card\">\n                <h5>Estimated Effort</h5>\n                <div class=\"effort-display\">${data.effort_estimation?.total_hours || 0}h</div>\n              </div>\n            </div>\n          </div>\n          \n          <div class=\"tab-content\" id=\"code-quality\">\n            <h4>Code Quality Analysis</h4>\n            <div class=\"quality-metrics\">\n              <div class=\"metric-item\">\n                <span class=\"metric-label\">PHPCS Score:</span>\n                <span class=\"metric-value\">${data.scores?.code_quality_score || 0}%</span>\n              </div>\n              <div class=\"metric-item\">\n                <span class=\"metric-label\">Security Score:</span>\n                <span class=\"metric-value\">${data.scores?.security_score || 0}%</span>\n              </div>\n              <div class=\"metric-item\">\n                <span class=\"metric-label\">Performance Score:</span>\n                <span class=\"metric-value\">${data.scores?.performance_score || 0}%</span>\n              </div>\n            </div>\n          </div>\n          \n          <div class=\"tab-content\" id=\"security\">\n            <h4>Security Analysis</h4>\n            <div class=\"security-details\">\n              ${generateSecurityDetails(data.analysis_details?.security_analysis || {})}\n            </div>\n          </div>\n          \n          <div class=\"tab-content\" id=\"performance\">\n            <h4>Performance Analysis</h4>\n            <div class=\"performance-details\">\n              ${generatePerformanceDetails(data.analysis_details?.performance_analysis || {})}\n            </div>\n          </div>\n          \n          <div class=\"tab-content\" id=\"upgrade\">\n            <h4>Upgrade Analysis</h4>\n            <div class=\"upgrade-details\">\n              ${generateUpgradeDetails(data.analysis_details?.upgrade_analysis || {})}\n            </div>\n          </div>\n          \n          <div class=\"tab-content\" id=\"recommendations\">\n            <h4>Recommendations</h4>\n            <div class=\"recommendations-list\">\n              ${generateRecommendations(data.recommendations || [])}\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n  }\n  \n  function generateSecurityDetails(security) {\n    return '<p>Security analysis details would be displayed here.</p>';\n  }\n  \n  function generatePerformanceDetails(performance) {\n    return '<p>Performance analysis details would be displayed here.</p>';\n  }\n  \n  function generateUpgradeDetails(upgrade) {\n    return '<p>Upgrade analysis details would be displayed here.</p>';\n  }\n  \n  function generateRecommendations(recommendations) {\n    if (!recommendations.length) {\n      return '<p>No specific recommendations at this time.</p>';\n    }\n    \n    return recommendations.map(rec => `\n      <div class=\"recommendation-item priority-${rec.priority || 'medium'}\">\n        <h5>${rec.title || 'Recommendation'}</h5>\n        <p>${rec.description || ''}</p>\n        <div class=\"recommendation-meta\">\n          <span class=\"category\">${rec.category || ''}</span>\n          <span class=\"effort\">${rec.effort || ''} effort</span>\n        </div>\n      </div>\n    `).join('');\n  }\n  \n  function initializeDetailedAnalysisTabs(container) {\n    const tabButtons = container.querySelectorAll('.tab-button');\n    const tabContents = container.querySelectorAll('.tab-content');\n    \n    tabButtons.forEach(button => {\n      button.addEventListener('click', function() {\n        const targetTab = this.dataset.tab;\n        \n        // Remove active class from all buttons and contents\n        tabButtons.forEach(btn => btn.classList.remove('active'));\n        tabContents.forEach(content => content.classList.remove('active'));\n        \n        // Add active class to clicked button and corresponding content\n        this.classList.add('active');\n        const targetContent = container.querySelector('#' + targetTab);\n        if (targetContent) {\n          targetContent.classList.add('active');\n        }\n      });\n    });\n  }\n  \n  function filterTable(container) {\n    const searchTerm = container.querySelector('#extension-search')?.value.toLowerCase() || '';\n    const typeFilter = container.querySelector('#type-filter')?.value || 'all';\n    const categoryFilter = container.querySelector('#category-filter')?.value || 'all';\n    const riskFilter = container.querySelector('#risk-filter')?.value || 'all';\n    const scoreFilter = container.querySelector('#score-filter')?.value || 'all';\n    \n    const rows = container.querySelectorAll('.extension-row');\n    \n    rows.forEach(function(row) {\n      let show = true;\n      \n      // Search filter\n      if (searchTerm) {\n        const name = row.querySelector('.extension-name')?.textContent.toLowerCase() || '';\n        const description = row.querySelector('.extension-description')?.textContent.toLowerCase() || '';\n        \n        if (!name.includes(searchTerm) && !description.includes(searchTerm)) {\n          show = false;\n        }\n      }\n      \n      // Type filter\n      if (typeFilter !== 'all' && row.dataset.type !== typeFilter) {\n        show = false;\n      }\n      \n      // Category filter\n      if (categoryFilter !== 'all' && row.dataset.category !== categoryFilter) {\n        show = false;\n      }\n      \n      // Risk filter\n      if (riskFilter !== 'all' && row.dataset.risk !== riskFilter) {\n        show = false;\n      }\n      \n      // Score filter\n      if (scoreFilter !== 'all') {\n        const score = parseInt(row.dataset.score) || 0;\n        let scoreMatch = false;\n        \n        switch (scoreFilter) {\n          case 'excellent':\n            scoreMatch = score >= 90;\n            break;\n          case 'good':\n            scoreMatch = score >= 70 && score < 90;\n            break;\n          case 'fair':\n            scoreMatch = score >= 50 && score < 70;\n            break;\n          case 'poor':\n            scoreMatch = score < 50;\n            break;\n        }\n        \n        if (!scoreMatch) {\n          show = false;\n        }\n      }\n      \n      row.style.display = show ? '' : 'none';\n    });\n  }\n  \n  function clearAllFilters(container) {\n    container.querySelector('#extension-search').value = '';\n    container.querySelector('#type-filter').value = 'all';\n    container.querySelector('#category-filter').value = 'all';\n    container.querySelector('#risk-filter').value = 'all';\n    container.querySelector('#score-filter').value = 'all';\n    filterTable(container);\n  }\n  \n  function sortTable(container, sortBy) {\n    // Table sorting implementation\n    console.log('Sorting by:', sortBy);\n  }\n  \n  function updateExtensionRow(name, results) {\n    // Update the table row with new analysis results\n    console.log('Updating row for:', name, results);\n  }\n  \n  function exportExtensionReport(name, format) {\n    console.log('Exporting report for:', name, 'in format:', format);\n  }\n  \n  function exportFullReport(format) {\n    console.log('Exporting full report in format:', format);\n  }\n  \n  function showLoadingOverlay(message) {\n    const overlay = document.querySelector('.loading-overlay');\n    if (overlay) {\n      const text = overlay.querySelector('.loading-text');\n      if (text) {\n        text.textContent = message;\n      }\n      overlay.style.display = 'flex';\n    }\n  }\n  \n  function hideLoadingOverlay() {\n    const overlay = document.querySelector('.loading-overlay');\n    if (overlay) {\n      overlay.style.display = 'none';\n    }\n  }\n  \n  function showSuccessMessage(message) {\n    console.log('Success:', message);\n    // Could implement a toast notification system here\n  }\n  \n  function showErrorMessage(message) {\n    console.error('Error:', message);\n    // Could implement a toast notification system here\n  }\n  \n  function runFullAnalysis(action) {\n    console.log('Running full analysis with action:', action);\n    showLoadingOverlay('Running comprehensive analysis...');\n    \n    // Simulate analysis process\n    setTimeout(() => {\n      hideLoadingOverlay();\n      showSuccessMessage('Full analysis completed');\n    }, 3000);\n  }\n\n})(jQuery, Drupal, once);"